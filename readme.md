# methylseqextractor

A tool allowing the flexible calculation of
DNA methylation concordance
and heterogeneity metrics in methyl-seq data.

## Installing dependencies

```bash
conda config --add channels r
conda config --add channels bioconda
conda create -n methex python=3.8
conda activate methex
conda install -c bioconda pysam
pip3 install pandas
pip3 install numpy
```

## Preparing the data

Each analysis is applied to a single sorted and indexed BAM file
generated by bwa-meth (https://github.com/brentp/bwa-meth). 
If necessary, the BAM file can be sorted and indexed using samtools, e.g.

```bash
samtools sort sample_unsorted.bam -o sample.bam
samtools index sample.bam
```

All analyses require the reference genome sequence
in an indexed FASTA file.

If necessary, a FASTA file can be indexed using samtools.

```bash
samtools faidx hg19.fa
```

## Running analyses

See [example.html](example.html) for an example
of possible analyses
as well as instructions for how to make use of multiple processors
for efficient genome-wide analyses. 

## Generating example.html

Generating example output file `example.html` from `example.qmd`
uses the `jupyter` Python package.
It can be installed as follows.

```bash
pip3 install jupyter
```

The code assumes the existence of `data/sample.bam` containing sequencing reads
covering at least chr1:1245000-1246000. 

A small example file was used to the generate `example.html`.
It was obtained from a real bam file (called `original.bam` below)
but down-sampled to simplify the output.

```bash
mkdir data
cd data
## if necessary, install samtools
conda install bioconda::samtools
## select reads from just chromosome 1
samtools view -bo chr1.bam original.bam chr1
## randomly retain 10% of the reads
samtools view -b -s 0.1 chr1.bam > sample.bam
## index the resulting file
samtools index sample.bam
```

The output file `example.html` can be generated using 'quarto'. 

```bash
quarto render example.qmd
```

## Evaluation

The DNA methylation levels and CAMDA scores calculated by the package
were evaluated for consistency with other implementations,
DNA methylation levels calculated using 
MethylDackel (https://github.com/dpryan79/MethylDackel) and
MethylKit (https://www.bioconductor.org/packages/release/bioc/html/methylKit.html)
and CAMDA scores using the original 
CAMDA package (https://github.com/JiejunShi/CAMDA).

The evaluation code is in a quarto file [evaluation.qmd](evaluation/evaluation.qmd)
and the output in html [evaluation.html](evaluation/evaluation.html).

DNA methylation levels were nearly identical (R > 0.999)
but CAMDA scores slightly lower (R=0.934).
The lower correlation is likely due to read alignment differences, 
we used bwa-meth (https://github.com/brentp/bwa-meth)
whereas the CAMDA package requires bsmap (https://github.com/genome-vendor/bsmap).